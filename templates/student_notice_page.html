{% load static %}
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Notices</title>
    <link rel="stylesheet" href="{% static 'css/addnotices.css' %}">
</head>
<body>
    <h1>Student Notices</h1>

    <h2>Create a New Student Notice</h2>
    <form id="studentNoticeForm" enctype="multipart/form-data">
        {%csrf_token%}
        <input type="hidden" id="studentNoticeId" name="noticeId" value="">
        <label for="noticeName">Notice Name</label>
        <input type="text" id="noticeName" name="NoticeName" placeholder="Enter Notice Name" required>
        
        <label for="noticeContent">Notice Content</label>
        <textarea id="noticeContent" name="NoticeContent" placeholder="Enter Notice Content" required></textarea>
        
        <label for="batchName">Select Batch</label>
        <select id="batchName" name="BatchName" multiple required>
            {% for batch in batches %}
            <!-- Example batch options, replace with dynamic content from your database -->
            
            <option value="{{batch.id}}">{{batch.BatchName}}</option>
            
            {% endfor%}
        </select>
        <button onclick="randomizeSelection()">Randomize Selection</button>

        <label for="fileAttachment">File Attachment</label>
        <input type="file" id="fileAttachment" name="FileAttachment">

        <button type="submit" class="button">Save Student Notice</button>
    </form>

    <h3>Existing Student Notices</h3>
    
<table>
    <thead>
        <tr>
            <th>Notice Name</th>
            <th>Notice Content</th>
            <th>File Attachment</th>
            <th>Associated Batches</th>  <!-- Added column for batches -->
            <th>Date</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        {% for snotice in studentnotices %}
        <tr>
            <td>{{ snotice.Notice_name }}</td>
            <td>{{ snotice.Notice_Content }}</td>
            <td>
                {% if snotice.File_Attachment %}
                    <a href="{{ snotice.File_Attachment.url }}" target="_blank">Download</a>
                {% else %}
                    No file attached
                {% endif %}
            </td>
            <td>
                {% if snotice.BatchName.all %}
                    <ul>
                        {% for batch in snotice.BatchName.all %}
                            <li>{{ batch.BatchName }}</li>  <!-- Display each associated batch -->
                        {% endfor %}
                    </ul>
                {% else %}
                    No batches associated
                {% endif %}
            </td>
            <td>{{ snotice.Date }}</td>
            <td>
                <button class="edit-button" data-id="{{ snotice.id }}">Edit</button>
                <button class="delete-button" data-id="{{ snotice.id }}">Delete</button>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>



    <script>
        function randomizeSelection() {
            var select = document.getElementById('batch');
            var options = select.options;
            
            // Loop through all options
            for (var i = 0; i < options.length; i++) {
              // Randomize each option's selected state
              options[i].selected = Math.random() < 0.5; // 50% chance of selection
            }
          }
</script> 

    <script>
        // Handle form submission for adding or updating a student notice
        document.getElementById('studentNoticeForm').addEventListener('submit', function(event) {
            event.preventDefault();
            let formData = new FormData(this);
            let noticeId = document.getElementById('studentNoticeId').value;

            let url = noticeId ? '/update_student_notice/' : '/create_student_notice/';
            fetch(url, {
                method: 'POST',
                body: formData,
            }).then(response => response.json())
              .then(data => {
                if (data.success) {
                    alert('Notice saved successfully!');
                    location.reload();  // Reload the page to reflect changes
                } else {
                    alert('Failed to save notice');
                }
            });
        });

        // Handle editing of student notices
        document.querySelectorAll('.edit-button').forEach(button => {
            button.addEventListener('click', function() {
                let noticeId = this.getAttribute('data-id');
                fetch(`/student-notices/${noticeId}/edit/`)
                    .then(response => response.json())
                    .then(data => {
                        document.getElementById('studentNoticeId').value = data.id;
                        document.getElementById('noticeName').value = data.Notice_name;
                        document.getElementById('noticeContent').value = data.Notice_Content;
                        // Optionally, you can pre-select batch values here
                    });
            });
        });

        // Handle deletion of student notices
        document.querySelectorAll('.delete-button').forEach(button => {
            button.addEventListener('click', function() {
                let noticeId = this.getAttribute('data-id');
                if (confirm('Are you sure you want to delete this notice?')) {
                    fetch('/delete_student_notice/', {
                        method: 'POST',
                        body: JSON.stringify({ noticeId }),
                        headers: { 'Content-Type': 'application/json' }
                    }).then(response => response.json())
                      .then(data => {
                        if (data.success) {
                            alert('Notice deleted successfully');
                            location.reload();  // Reload the page to reflect changes
                        } else {
                            alert('Failed to delete notice');
                        }
                    });
                }
            });
        });
    </script>
</body>
</html>
